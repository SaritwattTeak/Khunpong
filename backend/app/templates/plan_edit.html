{% extends "base.html" %}
{% block content %}

<h3>Edit Science Plan #{{ plan_id }}</h3>

{% if errors and errors|length > 0 %}
  <div class="alert alert-danger">
    <div class="fw-semibold mb-1">Please fix these errors:</div>
    <ul class="mb-0">
      {% for e in errors %}
        <li>{{ e }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

<form method="post" action="/plans/{{ plan_id }}/edit" class="card p-3">
  <div class="row g-3">

    <!-- Creator -->
    <div class="col-md-6">
      <label class="form-label">Creator</label>
      <input class="form-control" name="creator" value="{{ values.creator or '' }}" required>
    </div>

    <!-- Submitter -->
    <div class="col-md-6">
      <label class="form-label">Submitter</label>
      <input class="form-control" name="submitter" value="{{ values.submitter or '' }}" required>
    </div>

    <!-- Funding -->
    <div class="col-md-3">
      <label class="form-label">Funding</label>
      <input class="form-control" name="funding" type="number" step="0.01"
             value="{{ values.funding or '' }}" required>
    </div>

    <!-- Objective -->
    <div class="col-md-9">
      <label class="form-label">Objective (max 500 chars)</label>
      <input class="form-control" name="objective" maxlength="500"
             value="{{ values.objective or '' }}" required>
    </div>

    <!-- Star System -->
    <div class="col-md-6">
      <label class="form-label">Star System</label>
      <select class="form-select" name="star_system" required>
        <option value="">-- select --</option>
        {% for s in STAR_SYSTEMS %}
          <option value="{{s}}" {% if values.star_system == s %}selected{% endif %}>
            {{ s }}
          </option>
        {% endfor %}
      </select>
      <div class="form-text">Select from the official list in the data spec.</div>
    </div>

    <!-- Schedule Start -->
    <div class="col-md-3">
      <label class="form-label">Schedule Start</label>
      <input id="schedule_start"
             class="form-control"
             name="schedule_start"
             type="datetime-local"
             value="{{ values.schedule_start or '' }}"
             required>
    </div>

    <!-- Schedule End -->
    <div class="col-md-3">
      <label class="form-label">Schedule End</label>
      <input id="schedule_end"
             class="form-control"
             name="schedule_end"
             type="datetime-local"
             value="{{ values.schedule_end or '' }}"
             required>
    </div>

    <!-- Telescope -->
    <div class="col-md-4">
      <label class="form-label">Telescope Location</label>
      <select class="form-select" name="telescope_location" required>
        <option value="">-- select --</option>
        {% for t in TELESCOPE_LOCATIONS %}
          <option value="{{t}}" {% if values.telescope_location == t %}selected{% endif %}>
            {{ t }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- File Type -->
    <div class="col-md-4">
      <label class="form-label">File Type</label>
      <select class="form-select" name="file_type" required>
        <option value="">-- select --</option>
        {% for t in FILE_TYPES %}
          <option value="{{t}}" {% if values.file_type == t %}selected{% endif %}>
            {{ t }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- File Quality -->
    <div class="col-md-4">
      <label class="form-label">File Quality</label>
      <select class="form-select" name="file_quality" required>
        <option value="">-- select --</option>
        {% for q in FILE_QUALITIES %}
          <option value="{{q}}" {% if values.file_quality == q %}selected{% endif %}>
            {{ q }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Image Mode -->
    <div class="col-md-3">
      <label class="form-label">Image Mode</label>
      <select class="form-select" name="image_mode" required>
        <option value="">-- select --</option>
        {% for m in IMAGE_MODES %}
          <option value="{{m}}" {% if values.image_mode == m %}selected{% endif %}>
            {{ m }}
          </option>
        {% endfor %}
      </select>
    </div>

    <!-- Image Controls -->
    <div class="col-md-3">
      <label class="form-label">Exposure (0-50)</label>
      <input class="form-control" name="exposure" type="number"
             min="0" max="50"
             value="{{ values.exposure or 0 }}" required>
    </div>

    <div class="col-md-2">
      <label class="form-label">Contrast (0-50)</label>
      <input class="form-control" name="contrast" type="number"
             min="0" max="50"
             value="{{ values.contrast or 0 }}" required>
    </div>

    <div class="col-md-2">
      <label class="form-label">Brightness (0-50)</label>
      <input class="form-control" name="brightness" type="number"
             min="0" max="50"
             value="{{ values.brightness or 0 }}" required>
    </div>

    <div class="col-md-2">
      <label class="form-label">Saturation (0-50)</label>
      <input class="form-control" name="saturation" type="number"
             min="0" max="50"
             value="{{ values.saturation or 0 }}" required>
    </div>

    <!-- Buttons -->
    <div class="col-12 d-flex gap-2 pt-2">
      <button class="btn btn-primary" type="submit">Save Changes</button>
      <a class="btn btn-outline-secondary" href="/plans/{{ plan_id }}">Cancel</a>
    </div>

  </div>
</form>

<script>
  const startInput = document.getElementById("schedule_start");
  const endInput = document.getElementById("schedule_end");

  function validateDates() {
    if (startInput.value) {
      endInput.min = startInput.value;
      if (endInput.value && endInput.value < startInput.value) {
        endInput.value = "";
        alert("Schedule End cannot be earlier than Schedule Start.");
      }
    }
  }

  startInput.addEventListener("change", validateDates);
  endInput.addEventListener("change", validateDates);
  window.addEventListener("DOMContentLoaded", validateDates);
</script>

{% endblock %}
